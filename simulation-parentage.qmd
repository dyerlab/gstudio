# Simulation & Parentage

This chapter covers the forward-time population simulation framework and parentage analysis tools in `gstudio`.

```{r}
library(gstudio)
library(dplyr, warn.conflicts = FALSE)
```

## Building Populations from Frequencies

### Allele Frequency Specification

The simulation tools start with specifying allele frequencies per population and locus. The `make_populations()` function requires a data.frame with `Population`, `Locus`, `Allele`, and `Frequency` columns:

```{r}
f1 <- data.frame(
  Population = "A",
  Locus = rep(c("Loc1", "Loc2", "Loc3"), each = 2),
  Allele = rep(c("01", "02"), times = 3),
  Frequency = c(0.2, 0.8, 0.3, 0.7, 0.4, 0.6)
)
f2 <- data.frame(
  Population = "B",
  Locus = rep(c("Loc1", "Loc2", "Loc3"), each = 2),
  Allele = rep(c("01", "02"), times = 3),
  Frequency = c(0.7, 0.3, 0.5, 0.5, 0.6, 0.4)
)
f3 <- data.frame(
  Population = "C",
  Locus = rep(c("Loc1", "Loc2", "Loc3"), each = 2),
  Allele = rep(c("01", "02"), times = 3),
  Frequency = c(0.4, 0.6, 0.3, 0.7, 0.2, 0.8)
)
freqs <- rbind(f1, f2, f3)
freqs$Population <- factor(freqs$Population, ordered = TRUE)
```

### Creating Populations

```{r}
pop <- make_populations(freqs, N = 30)
head(pop)
table(pop$Population)
```

You can specify an inbreeding level with `F`:

```{r}
pop_inbred <- make_populations(freqs, N = 30, F = 0.3)
```

## Migration Models

The `migration_matrix()` function creates a K x K migration matrix where rows sum to 1. Element `[i,j]` is the proportion of population *i* that originates from population *j*.

### Island Model

Equal migration among all populations:

```{r}
migration_matrix(3, model = "island", m = 0.05)
```

### 1D Stepping Stone

Migration only between adjacent populations:

```{r}
migration_matrix(c("A", "B", "C", "D"),
                 model = "stepping_stone_1d", m = 0.1)
```

### 2D Stepping Stone

Grid-based adjacency:

```{r}
migration_matrix(4, model = "stepping_stone_2d",
                 m = 0.1, nr = 2, nc = 2)
```

### Distance-Based

Migration rate decays with distance:

```{r}
coords <- matrix(c(0, 0, 1, 0, 0.5, 1), ncol = 2, byrow = TRUE)
migration_matrix(3, model = "distance", m = 0.1, coords = coords)
```

## Migration Events

A `migration_event` pairs a migration matrix with a generation interval, allowing temporal regime changes:

```{r}
m1 <- migration_matrix(3, model = "island", m = 0.05)
m2 <- migration_matrix(3, model = "island", m = 0.20)

# Low migration for generations 1-50
evt1 <- migration_event(m1, start = 1, end = 50)

# High migration from generation 51 onward
evt2 <- migration_event(m2, start = 51)
```

## Mutation Models

The `mutation_model()` function defines how alleles mutate during simulation:

```{r}
# Infinite Alleles Model
mm_iam <- mutation_model(rate = 0.001, model = "iam")

# K-Allele Model (10 possible states)
mm_kam <- mutation_model(rate = 0.001, model = "kam", k = 10)

# Stepwise Mutation Model
mm_smm <- mutation_model(rate = 0.001, model = "smm")
```

## Forward-Time Simulation

The `simulate_pop()` function runs a multi-generation forward-time simulation. Each generation cycle: census, migrate, mate, mutate.

### Basic Simulation

```{r}
pop <- make_populations(freqs, N = 30)
result <- simulate_pop(pop, ngen = 20, verbose = FALSE)
head(result)
```

### With Migration

```{r}
m <- migration_matrix(3, model = "island", m = 0.05)
evt <- migration_event(m, start = 1)

result <- simulate_pop(pop, ngen = 20,
                       migration = evt,
                       verbose = FALSE)
```

### With Mutation

```{r}
mm <- mutation_model(rate = 0.01, model = "iam")
result <- simulate_pop(pop, ngen = 20,
                       mutation = mm,
                       verbose = FALSE)
```

### With Mixed Mating (Selfing)

```{r}
result <- simulate_pop(pop, ngen = 20,
                       selfing_rate = 0.3,
                       verbose = FALSE)
```

### Census Snapshots

Save population snapshots at regular intervals:

```{r}
#| eval: false
result <- simulate_pop(pop, ngen = 100,
                       census_interval = 25,
                       census_dir = tempdir(),
                       verbose = FALSE)
# Snapshots saved as gen_0025.rds, gen_0050.rds, etc.
```

### Complete Worked Example

Simulate drift and migration in a 3-population system, then analyze the outcome:

```{r}
# Create starting populations
pop <- make_populations(freqs, N = 50)

# Set up island model migration
m <- migration_matrix(3, model = "island", m = 0.02)
evt <- migration_event(m, start = 1)

# Run simulation
set.seed(42)
final <- simulate_pop(pop, ngen = 50,
                      migration = evt,
                      verbose = FALSE)

# Analyze structure in the final generation
genetic_structure(final, stratum = "Population", mode = "Gst")
```

```{r}
# Compare diversity before and after
genetic_diversity(pop, stratum = "Population", mode = "He")
genetic_diversity(final, stratum = "Population", mode = "He")
```

## Parentage Analysis

### Mating and Offspring

The `mate()` function creates offspring from two parents:

```{r}
f <- data.frame(
  Locus = rep(paste0("Loc", 1:4), each = 3),
  Allele = rep(LETTERS[1:3], times = 4),
  Frequency = rep(c(1/3, 1/3, 1/3), times = 4)
)
adults <- make_population(f, N = 20)
offs <- mate(adults[1, ], adults[2, ], N = 5)
offs
```

### Maternal Subtraction

The `minus_mom()` function removes the maternal contribution from offspring genotypes. It takes a single data.frame where mothers have `OffID = 0` and offspring have `OffID != 0`:

```{r}
# Combine mother and offspring into one data.frame
mom_row <- adults[1, ]
mom_row$OffID <- 0
offs$OffID <- 1:nrow(offs)
family <- rbind(mom_row, offs)
paternal <- minus_mom(family)
paternal
```

### Fractional Paternity

The `paternity()` function estimates the probability of each potential father siring each offspring:

```{r}
offs$OffID <- 1:nrow(offs)
offs$MomID <- adults$ID[1]
pat <- paternity(offs, adults[1, ], adults)
head(pat)
```

The `Fij` column gives the fractional paternity probability. Use `strict = TRUE` to retain only unambiguous assignments:

```{r}
pat_strict <- paternity(offs, adults[1, ], adults, strict = TRUE)
pat_strict
```

### Single-Parent Exclusion

The `parent_finder()` function identifies compatible parents for each offspring using exclusion. It requires a data.frame with `ID` and `OffID` columns, where adults have `OffID = 0`:

```{r}
# Prepare a combined data.frame
locus_cols <- column_class(adults, "locus")
adults2 <- adults[, c("ID", locus_cols)]
adults2$OffID <- 0
offs2 <- offs[, c("ID", locus_cols)]
offs2$OffID <- 1:nrow(offs2)
combined <- rbind(adults2, offs2)
result <- parent_finder(combined)
head(result)
```

### Identifying Bad Parents

The `bad_parents()` function flags parent-offspring pairs that are genetically incompatible:

```{r}
#| eval: false
bad_parents(offs, adults)
```

## Bundled Parentage Datasets

The `cornus` and `cornus_florida` datasets contain *Cornus florida* genotype data for parentage analysis:

```{r}
data(cornus)
head(cornus)
```

```{r}
data(cornus_florida)
head(cornus_florida)
```
